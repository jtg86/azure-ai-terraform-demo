name: Deploy

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - prod

env:
  TERRAFORM_VERSION: "1.6.0"
  ARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID }}
  ARM_CLIENT_SECRET: ${{ secrets.ARM_CLIENT_SECRET }}
  ARM_SUBSCRIPTION_ID: ${{ secrets.ARM_SUBSCRIPTION_ID }}
  ARM_TENANT_ID: ${{ secrets.ARM_TENANT_ID }}

jobs:
  deploy-infrastructure:
    name: Deploy Infrastructure
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    
    outputs:
      app_service_name: ${{ steps.apply.outputs.app_service_name }}
      resource_group: ${{ steps.apply.outputs.resource_group_name }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          terraform_wrapper: false
      
      - name: Terraform Init
        run: terraform init
        working-directory: infra/environments/${{ inputs.environment }}
      
      - name: Terraform Plan
        run: terraform plan -out=tfplan
        working-directory: infra/environments/${{ inputs.environment }}
      
      - name: Terraform Apply
        id: apply
        run: |
          terraform apply -auto-approve tfplan
          echo "app_service_name=$(terraform output -raw app_service_name)" >> $GITHUB_OUTPUT
          echo "resource_group_name=$(terraform output -raw resource_group_name)" >> $GITHUB_OUTPUT
        working-directory: infra/environments/${{ inputs.environment }}

  deploy-application:
    name: Deploy Application
    runs-on: ubuntu-latest
    needs: [deploy-infrastructure]
    environment: ${{ inputs.environment }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: |
            {
              "clientId": "${{ secrets.ARM_CLIENT_ID }}",
              "clientSecret": "${{ secrets.ARM_CLIENT_SECRET }}",
              "subscriptionId": "${{ secrets.ARM_SUBSCRIPTION_ID }}",
              "tenantId": "${{ secrets.ARM_TENANT_ID }}"
            }
      
      - name: Deploy to Azure App Service
        uses: azure/webapps-deploy@v2
        with:
          app-name: ${{ needs.deploy-infrastructure.outputs.app_service_name }}
          package: ./app

  smoke-test:
    name: Smoke Test
    runs-on: ubuntu-latest
    needs: [deploy-application, deploy-infrastructure]
    
    steps:
      - name: Wait for deployment
        run: sleep 60
      
      - name: Health check
        run: |
          APP_URL=$(az webapp show --name ${{ needs.deploy-infrastructure.outputs.app_service_name }} --resource-group ${{ needs.deploy-infrastructure.outputs.resource_group }} --query defaultHostName -o tsv)
          curl -f "https://${APP_URL}/health" || exit 1
        env:
          AZURE_CREDENTIALS: ${{ secrets.AZURE_CREDENTIALS }}
